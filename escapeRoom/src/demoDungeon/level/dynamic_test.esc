# =============================================================================
# Dynamic DSL Test File
# Tests all Tier 1-3 features: Variables, Expressions, Conditionals, Events, Triggers
# =============================================================================

escape_room:

    metadata:
        title: "Dynamic DSL Test Room"
        description: "A test room showcasing the new dynamic DSL features"
        difficulty: "normal"
        fog_of_war: false
        view_distance: 10
        camera_zoom: 1.0
        max_time: 600

    # =============================================================================
    # TIER 1: Variables
    # =============================================================================
    variables:
        score: 0
        keysCollected: 0
        totalKeys: 3
        secretFound: false
        playerName: "Hero"
        damageMultiplier: 1.5
        
        # Expression-based initial values
        startingGold: 50 + 25
        maxScore: 100 * 10



    # =============================================================================
    # Rooms with Event Handlers
    # =============================================================================
    rooms:
        entrance:
            description: "The entrance hall"
            x: 0
            y: 0
            width: 10
            height: 8
            connections: ["main_hall", "exit_room"]
            
            # TIER 3: Event handlers
            on_enter {
                show_message("Welcome to the Dynamic DSL Test Room!")
                print("Player entered entrance room")
                score += 10
            }
            
            on_first_enter {
                show_message("This is your first time here. Good luck!")
                give_item("starter_torch")
            }
    
        main_hall:
            description: "The main hall with treasures"
            x: 12
            y: 0
            width: 15
            height: 12
            connections: ["entrance", "treasure_room", "puzzle_room"]
            
            on_enter {
                print("Entered main hall, current score: ", score)
                
                # TIER 2: Conditional logic
                if (keysCollected > 0) {
                    show_message("You have " + keysCollected + " key(s)")
                } else {
                    show_message("Find keys to unlock the treasure room!")
                }
            }
    
        treasure_room:
            description: "A room filled with treasures"
            x: 29
            y: 0
            width: 8
            height: 8
            connections: ["main_hall"]
            locked_by: golden_key
            
            on_enter {
                show_message("You found the treasure room!")
                score += 100
            }
            
            on_first_enter {
                # TIER 2: Loop - spawn multiple gold piles
                repeat 3 {
                    print("Spawning treasure...")
                }
                score += 500
                show_message("First time treasure bonus: +500 points!")
            }
    
        puzzle_room:
            description: "A room with puzzles"
            x: 12
            y: 14
            width: 10
            height: 8
            connections: ["main_hall", "secret_room"]
            
            on_enter {
                # TIER 2: Math expressions
                score += 25 * damageMultiplier
                
                # TIER 2: Conditional with else
                if (score >= 500) {
                    show_message("Great progress! Score: " + score)
                } else {
                    show_message("Keep exploring! Current score: " + score)
                }
            }
    
        secret_room:
            description: "A hidden secret room"
            x: 24
            y: 14
            width: 6
            height: 6
            connections: ["puzzle_room"]
            
            on_first_enter {
                secretFound = true
                show_message("You discovered the secret room!")
                
                # TIER 2: Nested if
                if (keysCollected >= 2) {
                    show_message("And you have enough keys for a bonus!")
                    score += 200
                }
            }
    
        exit_room:
            description: "The exit"
            x: -10
            y: 0
            width: 6
            height: 6
            connections: ["entrance"]
            locked_by: exit_key
            
            on_enter {
                # TIER 2: Complex condition with && and ||
                if (keysCollected >= totalKeys && score >= 500) {
                    victory("Congratulations! You completed the test room!")
                } else {
                    if (keysCollected < totalKeys) {
                        show_message("You need all " + totalKeys + " keys to exit!")
                    } else {
                        show_message("You need at least 500 points to exit!")
                    }
                }
            }

    # =============================================================================
    # Quizzes with Event Handlers
    # =============================================================================
    quizzes:
        entrance_quiz:
            type: single_choice
            question: "What is 2 + 2?"
            answers: ["3", "4", "5", "22"]
            correct_answers: [1]
            explanation: "Basic math: 2 + 2 = 4"
            attached_to: ancient_scroll
            
            on_correct {
                show_message("Correct! You earned bonus points!")
                score += 100
                
                # TIER 2: Multiple operations
                keysCollected += 1
                show_message("Bonus: A key appeared!")
            }
            
            on_wrong {
                show_message("Incorrect! Try again!")
                player.health -= 10
            }

    # =============================================================================
    # Items with Event Handlers
    # =============================================================================
    items:
        golden_key:
            description: "A shiny golden key"
            type: "key"
            texture: "items/key/big_key.png"
            visible: true
            
            on_pickup {
                keysCollected += 1
                score += 50
                show_message("Key collected! (" + keysCollected + "/" + totalKeys + ")")
                print("Keys collected: ", keysCollected)
            }
    
        silver_key:
            description: "A silver key"
            type: "key"
            texture: "items/key/small_key.png"
            visible: true
            
            on_pickup {
                keysCollected += 1
                score += 50
                show_message("Silver key found! (" + keysCollected + "/" + totalKeys + ")")
            }
    
        bronze_key:
            description: "A bronze key"
            type: "key"
            texture: "items/key/small_key.png"
            visible: true
            
            on_pickup {
                keysCollected += 1
                score += 50
                show_message("Bronze key found! (" + keysCollected + "/" + totalKeys + ")")
            }
    
        exit_key:
            description: "The key to the exit"
            type: "key"
            texture: "items/key/small_key.png"
            visible: false
    
        health_potion:
            description: "A healing potion"
            type: "tool"
            texture: "items/potion/health_potion.png"
            visible: true
            
            on_pickup {
                show_message("You picked up a health potion!")
                score += 25
            }
            
            on_use {
                # TIER 2: Using built-in functions
                player.health = min(player.health + 50, player.maxHealth)
                show_message("Health restored!")
            }
    
        ancient_scroll:
            description: "An ancient scroll with mysterious writing"
            type: "readable"
            texture: "items/book/spell_book.png"
            readable: true
            content: "The secret room holds great treasures..."
            visible: true
            
            on_pickup {
                show_message("You found an ancient scroll!")
                score += 30
                
                # TIER 2: Expression in condition
                if (score + 100 > 300) {
                    show_message("Reading bonus activated!")
                    score += 100
                }
            }
    
        treasure_chest:
            description: "A treasure chest"
            type: "decoration"
            texture: "objects/chest"
            visible: true
            
            on_interact {
                # TIER 2: Random reward using expressions
                score += 100
                show_message("You found treasure! +100 points")
                
                if (score >= maxScore) {
                    show_message("You've reached the maximum score!")
                }
            }

    # =============================================================================
    # NPCs with Event Handlers
    # =============================================================================
    npcs:
        guide_npc:
            description: "A helpful guide"
            texture: "character/wizard/wizard_m"
            location: main_hall
            hostile: false
            dialogue:
                default: "Welcome, traveler! Find all the keys to escape."
            
            on_interact {
                show_message("Guide: Your current score is " + score)
                
                # TIER 2: Conditional dialogue
                if (keysCollected == 0) {
                    show_message("Guide: You haven't found any keys yet. Keep looking!")
                } else {
                    if (keysCollected < totalKeys) {
                        show_message("Guide: You have " + keysCollected + " keys. Find " + (totalKeys - keysCollected) + " more!")
                    } else {
                        show_message("Guide: You have all the keys! Head to the exit!")
                    }
                }
            }
        
        merchant:
            description: "A traveling merchant"
            texture: "character/wizard/wizard_m"
            location: treasure_room
            hostile: false
            dialogue:
                default: "Want to trade?"
            
            on_interact {
                if (player.gold >= 100) {
                    show_message("Merchant: Here's a special item for you!")
                    player.gold -= 100
                    score += 200
                } else {
                    show_message("Merchant: Come back when you have more gold!")
                }
            }
        
        skeleton_guard:
            description: "A skeleton guarding the treasure"
            texture: "character/monster/chort"
            location: treasure_room
            hostile: true
            health: 100
            damage: 15
            
            on_death {
                show_message("The skeleton guard has been defeated!")
                score += 150
                
                # TIER 2: Drop reward on death
                give_item("silver_key")
            }



    # =============================================================================
    # Player Configuration
    # =============================================================================
    player:
        class: wizard
        start_x: 5
        start_y: 4
        health: 200
        mana: 150
        stamina: 100
        speed: 1.2
        mana_restore: 15
        stamina_restore: 0.2

    # =============================================================================
    # TIER 3: Global Triggers
    # =============================================================================
    triggers:
        # Trigger when all keys are collected
        when (keysCollected >= totalKeys) {
            show_message("All keys collected! The exit is now unlocked!")
            unlock("exit_room")
            score += 500
        }
        
        # Trigger when score reaches a threshold
        when (score >= 1000) {
            show_message("Achievement unlocked: High Scorer!")
        }
        
        # Trigger for secret discovery
        when (secretFound == true) {
            show_message("You discovered a secret! Bonus points awarded!")
            score += 250
        }
